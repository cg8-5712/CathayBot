# AI Chat æ’ä»¶

é«˜çº§ AI å¯¹è¯æ’ä»¶ï¼Œæ”¯æŒå¤šæä¾›å•†ã€åˆ†ç¾¤ä¸Šä¸‹æ–‡ã€è‡ªå®šä¹‰ Prompt ç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¤– å¤š AI æä¾›å•†æ”¯æŒ
- **OpenAI**: GPT-4, GPT-3.5 ç­‰æ¨¡å‹
- **Claude**: Claude 3 ç³»åˆ—æ¨¡å‹
- æ”¯æŒè‡ªå®šä¹‰ API Baseï¼ˆä»£ç†/ç¬¬ä¸‰æ–¹æœåŠ¡ï¼‰

### ğŸ’¬ æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†
- **åˆ†ç¾¤ç‹¬ç«‹ä¸Šä¸‹æ–‡**: æ¯ä¸ªç¾¤èŠæ‹¥æœ‰ç‹¬ç«‹çš„å¯¹è¯å†å²
- **Redis + æ•°æ®åº“åŒå±‚å­˜å‚¨**: çƒ­æ•°æ®åœ¨ Redisï¼Œå†å²æ•°æ®æŒä¹…åŒ–åˆ°æ•°æ®åº“
- **è‡ªåŠ¨è¿‡æœŸæ¸…ç†**: å¯é…ç½®ä¸Šä¸‹æ–‡è¿‡æœŸæ—¶é—´
- **ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶**: é¿å… token è¶…é™

### ğŸ¯ çµæ´»çš„è§¦å‘æœºåˆ¶
- **@æœºå™¨äººè§¦å‘**: åœ¨ç¾¤èŠä¸­ @æœºå™¨äººå³å¯å¯¹è¯
- **å›å¤è§¦å‘**: å›å¤æœºå™¨äººçš„æ¶ˆæ¯ç»§ç»­å¯¹è¯
- **å…³é”®è¯è§¦å‘**: é…ç½®ç‰¹å®šå…³é”®è¯è‡ªåŠ¨è§¦å‘
- **éšæœºå›å¤**: å¯é…ç½®æ¦‚ç‡éšæœºå‚ä¸ç¾¤èŠ

### ğŸ¨ è‡ªå®šä¹‰ Prompt
- **å…¨å±€ Prompt**: è®¾ç½®æœºå™¨äººçš„åŸºç¡€äººæ ¼
- **åˆ†ç¾¤ Prompt**: ä¸ºä¸åŒç¾¤èŠè®¾ç½®ä¸åŒçš„äººæ ¼
- **åŠ¨æ€å˜é‡**: æ”¯æŒ `{group_name}`, `{user_name}` ç­‰å˜é‡

### ğŸ›¡ï¸ å®‰å…¨ä¸é™åˆ¶
- **é€Ÿç‡é™åˆ¶**: é˜²æ­¢æ»¥ç”¨ï¼Œå¯é…ç½®ç”¨æˆ·/ç¾¤ç»„é™åˆ¶
- **å†…å®¹è¿‡æ»¤**: æ•æ„Ÿè¯è¿‡æ»¤
- **è¶…æ—¶ä¿æŠ¤**: é˜²æ­¢ API è°ƒç”¨è¶…æ—¶

### âš¡ é«˜çº§ç‰¹æ€§
- **æµå¼è¾“å‡º**: æ”¯æŒæ‰“å­—æ•ˆæœï¼ˆå®æ—¶æ›´æ–°æ¶ˆæ¯ï¼‰
- **è®°å¿†åŠŸèƒ½**: å¯é€‰çš„é•¿æœŸè®°å¿†å­˜å‚¨
- **å›¾ç‰‡è¯†åˆ«**: æ”¯æŒå¤šæ¨¡æ€æ¨¡å‹ï¼ˆéœ€é…ç½®ï¼‰

## å®‰è£…é…ç½®

### 1. å®‰è£…ä¾èµ–

```bash
pip install httpx
```

### 2. é…ç½®æ–‡ä»¶

ç¼–è¾‘ `configs/plugins/ai_chat.yaml`:

```yaml
# åŸºç¡€é…ç½®
provider: openai  # æˆ– claude
api_key: "your-api-key-here"  # å¿…å¡«
model: "gpt-4o-mini"

# è§¦å‘æ–¹å¼
trigger_on_at: true
trigger_on_reply: true
trigger_keywords: ["å°åŠ©æ‰‹", "AI"]

# ä¸Šä¸‹æ–‡è®¾ç½®
max_context_messages: 20
enable_context: true

# è‡ªå®šä¹‰ Prompt
system_prompt: |
  ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ AI åŠ©æ‰‹...
```

### 3. å¯åŠ¨æœºå™¨äºº

æ’ä»¶ä¼šè‡ªåŠ¨åŠ è½½ï¼Œæ— éœ€é¢å¤–æ“ä½œã€‚

## ä½¿ç”¨æ–¹æ³•

### åŸºç¡€å¯¹è¯

**ç¾¤èŠä¸­ï¼š**
```
@æœºå™¨äºº ä½ å¥½
@æœºå™¨äºº ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ
```

**ç§èŠä¸­ï¼š**
```
/chat ä½ å¥½
/chat å¸®æˆ‘å†™ä¸€æ®µä»£ç 
```

### ç®¡ç†å‘½ä»¤

**æ¸…ç©ºä¸Šä¸‹æ–‡ï¼š**
```
/chat clear
```

**è®¾ç½®ç¾¤ Promptï¼ˆä»…ç®¡ç†å‘˜ï¼‰ï¼š**
```
/chat prompt ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯åŠ©æ‰‹ï¼Œæ“…é•¿è§£ç­”ç¼–ç¨‹é—®é¢˜
```

## é…ç½®è¯´æ˜

### æä¾›å•†é…ç½®

#### OpenAI
```yaml
provider: openai
api_key: "sk-..."
model: "gpt-4o-mini"  # æˆ– gpt-4, gpt-3.5-turbo
api_base: ""  # å¯é€‰ï¼Œä½¿ç”¨ä»£ç†æ—¶å¡«å†™
```

#### Claude
```yaml
provider: claude
api_key: "sk-ant-..."
model: "claude-3-5-sonnet-20241022"
api_base: ""  # å¯é€‰
```

### è§¦å‘é…ç½®

```yaml
# @æœºå™¨äººè§¦å‘
trigger_on_at: true

# å›å¤æœºå™¨äººæ¶ˆæ¯è§¦å‘
trigger_on_reply: true

# å…³é”®è¯è§¦å‘
trigger_keywords:
  - "å°åŠ©æ‰‹"
  - "AI"
  - "å¸®æˆ‘"

# éšæœºå›å¤ï¼ˆ0.0-1.0ï¼‰
random_reply_probability: 0.05  # 5% æ¦‚ç‡éšæœºå›å¤
```

### ä¸Šä¸‹æ–‡é…ç½®

```yaml
# æœ€å¤§ä¿ç•™æ¶ˆæ¯æ•°
max_context_messages: 20

# ä¸Šä¸‹æ–‡è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
context_expire_seconds: 3600  # 1å°æ—¶

# æ˜¯å¦å¯ç”¨ä¸Šä¸‹æ–‡
enable_context: true
```

### Prompt é…ç½®

**å…¨å±€ Promptï¼š**
```yaml
system_prompt: |
  ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€å¹½é»˜çš„ AI åŠ©æ‰‹ã€‚
  å½“å‰ç¾¤èŠï¼š{group_name}
  å½“å‰ç”¨æˆ·ï¼š{user_name}
```

**åˆ†ç¾¤ Promptï¼š**
```yaml
group_prompts:
  "123456789": |
    ä½ æ˜¯ä¸€ä¸ªæŠ€æœ¯ç¾¤çš„åŠ©æ‰‹ï¼Œæ“…é•¿è§£ç­”ç¼–ç¨‹é—®é¢˜ã€‚
  "987654321": |
    ä½ æ˜¯ä¸€ä¸ªå¨±ä¹ç¾¤çš„åŠ©æ‰‹ï¼Œå–œæ¬¢å¼€ç©ç¬‘ã€‚
```

### é€Ÿç‡é™åˆ¶

```yaml
# æ¯ç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°
rate_limit_per_user: 10

# æ¯ç¾¤æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°
rate_limit_per_group: 30
```

### é«˜çº§åŠŸèƒ½

```yaml
# æµå¼è¾“å‡ºï¼ˆæ‰“å­—æ•ˆæœï¼‰
enable_stream: false

# å†…å®¹è¿‡æ»¤
enable_content_filter: true
blocked_words:
  - "æ•æ„Ÿè¯1"
  - "æ•æ„Ÿè¯2"

# å›¾ç‰‡è¯†åˆ«ï¼ˆéœ€è¦æ”¯æŒçš„æ¨¡å‹ï¼‰
enable_image_recognition: false

# è®°å¿†åŠŸèƒ½
enable_memory: true
```

## æ¶æ„è®¾è®¡

### æ¨¡å—ç»“æ„

```
ai_chat/
â”œâ”€â”€ __init__.py          # ä¸»é€»è¾‘ï¼šæ¶ˆæ¯ç›‘å¬ã€å‘½ä»¤å¤„ç†
â”œâ”€â”€ config.py            # é…ç½®æ¨¡å‹
â”œâ”€â”€ context.py           # ä¸Šä¸‹æ–‡ç®¡ç†ï¼šRedis + æ•°æ®åº“
â”œâ”€â”€ models.py            # æ•°æ®æ¨¡å‹ï¼šèŠå¤©å†å²ã€è®°å¿†
â””â”€â”€ providers/           # AI æä¾›å•†
    â”œâ”€â”€ base.py          # æŠ½è±¡åŸºç±»
    â”œâ”€â”€ openai.py        # OpenAI å®ç°
    â””â”€â”€ claude.py        # Claude å®ç°
```

### æ•°æ®æµ

```
ç”¨æˆ·æ¶ˆæ¯ â†’ è§¦å‘æ£€æŸ¥ â†’ é€Ÿç‡é™åˆ¶ â†’ ä¸Šä¸‹æ–‡åŠ è½½
    â†“
AI æä¾›å•† â† Prompt æ„å»º â† ä¸Šä¸‹æ–‡æ ¼å¼åŒ–
    â†“
å›å¤ç”Ÿæˆ â†’ å†…å®¹è¿‡æ»¤ â†’ ä¸Šä¸‹æ–‡ä¿å­˜ â†’ å‘é€æ¶ˆæ¯
```

### å­˜å‚¨è®¾è®¡

**Redisï¼ˆçƒ­æ•°æ®ï¼‰ï¼š**
- `ai_chat:context:{conv_id}` - ä¸Šä¸‹æ–‡æ¶ˆæ¯åˆ—è¡¨
- `ai_chat:rate:user:{user_id}:{minute}` - ç”¨æˆ·é€Ÿç‡è®¡æ•°
- `ai_chat:rate:group:{group_id}:{minute}` - ç¾¤é€Ÿç‡è®¡æ•°

**æ•°æ®åº“ï¼ˆå†·æ•°æ®ï¼‰ï¼š**
- `ai_chat_history` - èŠå¤©å†å²è®°å½•
- `ai_chat_memory` - AI è®°å¿†å­˜å‚¨

## æœ€ä½³å®è·µ

### 1. Prompt è®¾è®¡

**å¥½çš„ Promptï¼š**
```yaml
system_prompt: |
  ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„ AI åŠ©æ‰‹ï¼Œåå«å°æ™ºã€‚

  æ€§æ ¼ç‰¹ç‚¹ï¼š
  - å¹½é»˜é£è¶£ï¼Œä½†ä¸æ²¹è…»
  - ä¹äºåŠ©äººï¼Œè€å¿ƒè§£ç­”
  - ä¼šç”¨è¡¨æƒ…å’Œç½‘ç»œç”¨è¯­

  å›å¤åŸåˆ™ï¼š
  - ç®€æ´æ˜äº†ï¼Œä¸è¶…è¿‡ 3 å¥è¯
  - ä¸ç¡®å®šæ—¶å¦è¯šè¯´ä¸çŸ¥é“
  - é¿å…é‡å¤ç”¨æˆ·çš„é—®é¢˜

  å½“å‰ç¯å¢ƒï¼š
  - ç¾¤èŠï¼š{group_name}
  - ç”¨æˆ·ï¼š{user_name}
```

### 2. è§¦å‘ç­–ç•¥

**æ¨èé…ç½®ï¼š**
```yaml
# ä¸»åŠ¨è§¦å‘
trigger_on_at: true
trigger_on_reply: true

# è¢«åŠ¨è§¦å‘ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
trigger_keywords: ["å°åŠ©æ‰‹"]  # å°‘é‡å…³é”®è¯
random_reply_probability: 0.02  # ä½æ¦‚ç‡éšæœº
```

### 3. ä¸Šä¸‹æ–‡ç®¡ç†

**å»ºè®®è®¾ç½®ï¼š**
```yaml
max_context_messages: 15-20  # å¹³è¡¡è®°å¿†å’Œæˆæœ¬
context_expire_seconds: 1800-3600  # 30åˆ†é’Ÿåˆ°1å°æ—¶
```

### 4. æˆæœ¬æ§åˆ¶

- ä½¿ç”¨ `gpt-4o-mini` è€Œé `gpt-4`ï¼ˆæˆæœ¬é™ä½ 90%ï¼‰
- è®¾ç½®åˆç†çš„é€Ÿç‡é™åˆ¶
- é™åˆ¶ `max_reply_length`
- å®šæœŸæ¸…ç†è¿‡æœŸä¸Šä¸‹æ–‡

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•ä½¿ç”¨å›½å†… API ä»£ç†ï¼Ÿ

A: é…ç½® `api_base`:
```yaml
provider: openai
api_base: "https://your-proxy.com/v1"
```

### Q: å¦‚ä½•è®©æœºå™¨äººæ›´æ´»è·ƒï¼Ÿ

A: å¢åŠ éšæœºå›å¤æ¦‚ç‡å’Œå…³é”®è¯ï¼š
```yaml
random_reply_probability: 0.1  # 10% æ¦‚ç‡
trigger_keywords: ["å°åŠ©æ‰‹", "AI", "å¸®æˆ‘", "é—®ä¸€ä¸‹"]
```

### Q: å¦‚ä½•é˜²æ­¢åˆ·å±ï¼Ÿ

A: è°ƒæ•´é€Ÿç‡é™åˆ¶ï¼š
```yaml
rate_limit_per_user: 5  # é™ä½é™åˆ¶
rate_limit_per_group: 20
```

### Q: ä¸Šä¸‹æ–‡ä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ

A: ä½¿ç”¨ `/chat clear` æ¸…ç©ºä¸Šä¸‹æ–‡ï¼Œæˆ–è°ƒæ•´ï¼š
```yaml
max_context_messages: 10  # å‡å°‘ä¸Šä¸‹æ–‡é•¿åº¦
```

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„ AI æä¾›å•†

1. åœ¨ `providers/` ä¸‹åˆ›å»ºæ–°æ–‡ä»¶
2. ç»§æ‰¿ `AIProvider` åŸºç±»
3. å®ç° `chat()` å’Œ `chat_stream()` æ–¹æ³•
4. åœ¨ `__init__.py` ä¸­æ³¨å†Œ

ç¤ºä¾‹ï¼š
```python
from .base import AIProvider

class CustomProvider(AIProvider):
    async def chat(self, messages, system_prompt=None, **kwargs):
        # å®ç°ä½ çš„ API è°ƒç”¨
        pass
```

### æ·»åŠ è®°å¿†åŠŸèƒ½

ä½¿ç”¨ `ChatMemory` æ¨¡å‹å­˜å‚¨é•¿æœŸè®°å¿†ï¼š
```python
from .models import ChatMemory

# ä¿å­˜è®°å¿†
memory = ChatMemory(
    conv_id=conv_id,
    memory_type="fact",
    key="user_preference",
    value="å–œæ¬¢Pythonç¼–ç¨‹"
)
```

## è®¸å¯è¯

MIT License

## ä½œè€…

cg8-5712
